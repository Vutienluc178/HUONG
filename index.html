<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rung Chu√¥ng V√†ng - Chinh Ph·ª•c ƒêa V≈© Tr·ª•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0F172A; /* slate-900 */
            background-size: cover;
            background-position: center;
            color: #E2E8F0; /* slate-200 */
            overflow: hidden;
            transition: background-image 0.7s ease-in-out;
        }
        .screen {
            display: none;
            width: 100%;
            animation: fadeIn 0.7s ease-in-out;
        }
        .screen.active {
            display: flex;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.8); /* bg-slate-900 with 80% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(56, 189, 248, 0.2); /* cyan-400 */
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            animation: slideInUp 0.6s ease-out;
        }
        .btn-glow {
            position: relative; /* Added for pseudo-elements */
            background: linear-gradient(45deg, #0ea5e9, #6366f1);
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.5);
            transition: all 0.2s ease-in-out;
            color: white;
            font-weight: 600;
        }
        .btn-glow:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 25px rgba(14, 165, 233, 0.8);
        }
        .btn-glow:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 0 8px rgba(14, 165, 233, 0.6);
        }
        .btn-glow:disabled {
            background: #334155; /* slate-700 */
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }
        .winner-trophy {
            animation: float 3s ease-in-out infinite;
            text-shadow: 0 0 20px #FACC15; /* amber-400 */
        }
        .timer-warning {
            animation: pulseRed 1s infinite;
        }
        .bg-option.selected {
            border: 3px solid #0ea5e9; /* cyan-500 */
            transform: scale(1.05);
        }
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 210; /* Above background, below modal content */
            pointer-events: none;
            display: none;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }
        @keyframes pulsate { 0% { box-shadow: 0 0 15px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 25px rgba(236, 72, 153, 1); } 100% { box-shadow: 0 0 15px rgba(236, 72, 153, 0.5); } }
        @keyframes pulseRed { 0% { transform: scale(1); color: #fb7185; } 50% { transform: scale(1.1); color: #f43f5e; } 100% { transform: scale(1); color: #fb7185; } }

        /* Effects CSS */
        #mascot.mascot-bounce { animation: bounce 0.5s ease; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        .sparkle { position: absolute; width: 10px; height: 10px; background: #fde047; border-radius: 50%; pointer-events: none; z-index: 100; animation: sparkle-burst 0.6s ease-out forwards; box-shadow: 0 0 10px #fde047; }
        @keyframes sparkle-burst { from { transform: scale(1); opacity: 1; } to { transform: scale(0) translate(var(--tx), var(--ty)); opacity: 0; } }
        
        .confetti-piece { position: absolute; width: 10px; height: 10px; background-color: var(--color); top: -20px; opacity: 0; animation: confetti-fall 5s linear forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        
        #evolution-display { transition: transform 0.3s ease; }
        #evolution-display.evolved { animation: evolution-pop 0.5s ease-out; }
        @keyframes evolution-pop { 0% { transform: scale(1); } 50% { transform: scale(1.5) rotate(15deg); } 100% { transform: scale(1) rotate(0deg); } }

        @keyframes shake-horizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake-it {
            animation: shake-horizontal 0.6s both;
        }

        #question-container.pop-in {
            animation: pop-in 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .correct-answer-glow::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            padding-bottom: 200%;
            background: radial-gradient(circle, rgba(34,197,94,0.4) 0%, rgba(34,197,94,0) 60%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: radiate 0.8s ease-out;
            z-index: -1;
        }
        @keyframes radiate {
            from { transform: translate(-50%, -50%) scale(0); opacity: 0.8; }
            to { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="volume-control" class="fixed top-4 right-4 text-4xl cursor-pointer z-50" style="text-shadow: 0 0 10px #0ea5e9;">üîä</div>
    <div id="fullscreen-control" class="fixed top-5 right-16 text-3xl cursor-pointer z-50" title="To√†n m√†n h√¨nh" style="text-shadow: 0 0 10px #0ea5e9;">‚õ∂</div>
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[100]"></div>
    <div id="feedback-overlay" class="absolute inset-0 flex items-center justify-center text-6xl font-bold text-white opacity-0 pointer-events-none transition-opacity duration-500 z-[240]"></div>
    <canvas id="fireworks-canvas"></canvas>

    <!-- Main Menu Screen -->
    <div id="main-menu-screen" class="screen justify-center items-center active">
        <div class="glass-card p-8 w-full max-w-4xl text-center">
            <h1 class="text-5xl font-bold text-cyan-300 mb-4">CH·ªåN CU·ªòC PHI√äU L∆ØU</h1>
            <p class="text-slate-300 mb-6 text-lg">M·ªói h√†nh tr√¨nh l√† m·ªôt th·ª≠ th√°ch m·ªõi. B·∫°n ƒë√£ s·∫µn s√†ng ch∆∞a?</p>
            <div class="mb-6">
                <h2 class="text-2xl text-amber-300 font-semibold mb-3">B·ªò S∆ØU T·∫¨P HUY HI·ªÜU</h2>
                <div id="badge-collection" class="flex justify-center items-center gap-4 text-4xl">
                    <!-- Badges will be injected by JS -->
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <button data-mission-id="space" class="mission-btn btn-glow w-full text-xl py-4">üöÄ Chinh Ph·ª•c Ng√¢n H√†</button>
                <button data-mission-id="science" class="mission-btn btn-glow w-full text-xl py-4">ü™ê Ph√≤ng Th√≠ Nghi·ªám B√≠ ·∫®n</button>
                <button data-mission-id="jungle" class="mission-btn btn-glow w-full text-xl py-4" style="background: linear-gradient(45deg, #16a34a, #22c55e);">üå≥ Cu·ªôc ƒêua K·ª≥ Th√∫</button>
                <button data-mission-id="ocean" class="mission-btn btn-glow w-full text-xl py-4" style="background: linear-gradient(45deg, #0891b2, #22d3ee);">üê† SƒÉn T√¨m Kho B√°u</button>
                <button data-mission-id="fairytale" class="mission-btn btn-glow w-full text-xl py-4" style="background: linear-gradient(45deg, #c026d3, #ec4899);">üè∞ L√¢u ƒê√†i Ph√©p Thu·∫≠t</button>
                <button data-mission-id="vietnam" class="mission-btn btn-glow w-full text-xl py-4" style="background: linear-gradient(45deg, #dc2626, #f97316);">üáªüá≥ Kh√°m Ph√° Vi·ªát Nam Di·ªáu K·ª≥</button>
            </div>
            <button id="settings-btn" class="btn-glow w-full text-xl py-3 mt-4" style="background: linear-gradient(45deg, #334155, #475569);">‚öôÔ∏è C√†i ƒê·∫∑t</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-[200] hidden">
        <div class="glass-card p-8 w-full max-w-4xl text-center relative overflow-y-auto max-h-screen">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-4xl text-slate-300 hover:text-white">&times;</button>
            <h2 class="text-4xl font-bold text-cyan-300 mb-6">C√†i ƒê·∫∑t</h2>
            
            <div class="border-t border-slate-700 pt-6 mb-6">
                <h3 class="text-3xl font-bold text-cyan-300 mb-6">Thay ƒê·ªïi H√¨nh N·ªÅn</h3>
                <div id="background-options" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                <button id="reset-bg-btn" class="btn-glow w-full text-xl py-3" style="background: linear-gradient(45deg, #ef4444, #dc2626);">Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh</button>
            </div>
            
            <div class="border-t border-slate-700 pt-6 mb-6">
                <h3 class="text-3xl font-bold text-cyan-300 mb-6">C√†i ƒê·∫∑t Th·ªùi Gian</h3>
                <div class="flex items-center justify-center gap-4">
                    <label for="time-setting-input" class="text-xl">Th·ªùi gian m·ªói c√¢u (5-180 gi√¢y):</label>
                    <input type="number" id="time-setting-input" min="5" max="180" class="w-24 p-2 rounded-lg bg-slate-800 text-center text-xl font-bold focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
            </div>

            <div class="border-t border-slate-700 pt-6">
                <h3 class="text-3xl font-bold text-cyan-300 mb-6">Ch·ªânh S·ª≠a B·ªô C√¢u H·ªèi</h3>
                <div class="flex items-center justify-center gap-4 mb-4">
                    <label for="mission-select-for-edit" class="text-xl">Ch·ªçn b·ªô c√¢u h·ªèi:</label>
                    <select id="mission-select-for-edit" class="p-2 rounded-lg bg-slate-800 text-xl font-bold focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <textarea id="questions-input" class="w-full h-64 p-4 border border-slate-600 rounded-lg bg-slate-800 bg-opacity-70 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-400"></textarea>
                <p id="setup-error" class="text-red-400 mt-4 font-semibold hidden"></p>
            </div>
        </div>
    </div>

    <!-- Intro Modal -->
    <div id="intro-modal" class="fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-[200] hidden">
        <div class="glass-card p-8 w-full max-w-2xl text-center">
            <div id="intro-icon" class="text-8xl mb-4"></div>
            <h1 id="intro-title" class="text-4xl font-bold text-cyan-300 mb-2"></h1>
            <p id="intro-text" class="text-lg text-amber-200 my-4 italic"></p>
            <div class="flex space-x-4 mt-6">
                <button id="back-from-intro-btn" class="btn-glow w-1/3 text-2xl py-4" style="background: linear-gradient(45deg, #6b7280, #4b5563);">QUAY L·∫†I</button>
                <button id="start-from-intro-btn" class="btn-glow w-2/3 text-2xl py-4">B·∫ÆT ƒê·∫¶U!</button>
            </div>
        </div>
    </div>
    
    <!-- Pause Modal -->
    <div id="pause-modal" class="fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-[200] hidden">
        <div class="glass-card p-8 w-full max-w-sm text-center">
            <h2 class="text-4xl font-bold text-cyan-300 mb-6">ƒê√É T·∫†M D·ª™NG</h2>
            <button id="resume-btn" class="btn-glow w-full text-xl py-3">TI·∫æP T·ª§C</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen flex-col p-4 md:p-8 w-full h-full">
        <!-- Top Bar -->
        <div class="flex justify-between items-center w-full mb-4 flex-wrap">
            <div class="flex items-center gap-4">
                <div id="progress-indicator" class="text-xl md:text-2xl font-bold text-cyan-300"></div>
                <div id="evolution-display" class="text-4xl md:text-5xl"></div>
            </div>
            <div id="score-display" class="text-2xl md:text-3xl font-bold text-amber-300">ƒêi·ªÉm: 0</div>
            <div class="flex items-center gap-4">
                <div class="text-4xl md:text-5xl font-bold text-fuchsia-400" id="timer"></div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button id="quit-game-btn" class="text-3xl md:text-4xl cursor-pointer hover:scale-110 transition-transform" title="V·ªÅ m√†n h√¨nh ch√≠nh">‚è™</button>
                    <button id="pause-btn" class="text-3xl md:text-4xl cursor-pointer hover:scale-110 transition-transform" title="T·∫°m d·ª´ng">‚è∏Ô∏è</button>
                    <button id="help-btn" class="btn-glow px-3 py-1 md:px-4 md:py-2 rounded-lg text-base md:text-lg" style="background: linear-gradient(45deg, #ec4899, #d946ef);">‚ö° Tr·ª£ Gi√∫p</button>
                </div>
            </div>
        </div>

        <!-- Question Area -->
        <div id="question-container" class="flex-grow w-full flex items-center justify-center my-4 glass-card p-6">
            <h2 id="question-text" class="text-4xl md:text-6xl font-semibold text-white text-center"></h2>
        </div>

        <!-- Answers Area -->
        <div id="answers-container" class="w-full max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
        </div>
    </div>


    <!-- Result Screen -->
    <div id="result-screen" class="screen justify-center items-center">
        <div class="glass-card p-12 relative w-full max-w-2xl text-center">
            <h2 id="result-title" class="text-5xl font-bold text-cyan-300 mb-4"></h2>
            <div id="result-icon" class="text-8xl mb-6"></div>
            <p id="final-score-display" class="text-3xl text-amber-300 font-bold mb-6"></p>
            <p id="result-message" class="text-xl text-slate-300 mb-8"></p>
            <button id="continue-to-thanks-btn" class="btn-glow w-full text-2xl py-4">K·∫øt Th√∫c</button>
        </div>
    </div>

    <!-- Thank You Screen -->
    <div id="thank-you-screen" class="screen justify-center items-center" style="z-index: 220;">
        <div class="glass-card p-12 w-full max-w-2xl text-center">
            <h2 class="text-5xl font-bold text-cyan-300 mb-8">C·∫£m ∆†n!</h2>
            <p class="text-2xl text-slate-200 mb-10">C·∫£m ∆°n qu√Ω th·∫ßy c√¥ v√† c√°c em h·ªçc sinh ƒë√£ tham gia ti·∫øt h·ªçc vui v·∫ª n√†y!</p>
            <button id="home-btn" class="btn-glow w-full text-2xl py-4">V·ªÄ M√ÄN H√åNH CH√çNH</button>
        </div>
    </div>
    
    <div id="mascot" class="fixed bottom-4 left-4 text-6xl z-50 transition-transform duration-300"></div>
    <footer class="fixed bottom-4 left-0 right-0 text-center text-slate-300 text-sm z-50" style="text-shadow: 0 0 5px rgba(14, 165, 233, 0.7);">
        H·ªåC V√Ä CH∆†I C√ôNG C√î V≈® TH·ªä H∆Ø∆†NG - TR∆Ø·ªúNG TI·ªÇU H·ªåC H·∫¢I THANH
    </footer>

    <script>
        // --- Configurations ---
        const backgrounds = {
            default_space: `url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop')`,
            deep_space: `url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1822&auto=format&fit=crop')`,
            default_jungle: `url('https://images.unsplash.com/photo-1425913397330-cf8af2ff40a1?q=80&w=1974&auto=format&fit=crop')`,
            fantasy_forest: `url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop')`,
            default_ocean: `url('https://images.unsplash.com/photo-1524704796725-9fc3044a58b2?q=80&w=2070&auto=format&fit=crop')`,
            coral_reef: `url('https://images.unsplash.com/photo-1551893309-c47312150488?q=80&w=2070&auto=format&fit=crop')`,
            abstract_tech: `url('https://images.unsplash.com/photo-1531315630201-bb15ab376539?q=80&w=2070&auto=format&fit=crop')`,
            default_fairytale: `url('https://images.unsplash.com/photo-1597406603553-56233a75e3a3?q=80&w=1974&auto=format&fit=crop')`,
            default_vietnam: `url('https://images.unsplash.com/photo-1528127269322-539801943592?q=80&w=2070&auto=format&fit=crop')`
        };
        const missions = {
            space: { title: 'Chinh Ph·ª•c Ng√¢n H√†', icon: 'üöÄ', intro: "Ch√†o m·ª´ng thuy·ªÅn tr∆∞·ªüng! H√£y tr·∫£ l·ªùi c√°c c√¢u h·ªèi ƒë·ªÉ l·∫Øp r√°p con t√†u v≈© tr·ª• v√† b·∫Øt ƒë·∫ßu h√†nh tr√¨nh kh√°m ph√° c√°c v√¨ sao nh√©!", progressText: 'H√†nh tinh', questions: `NƒÉm nay Nam 7 tu·ªïi ch·ªã Mai h∆°n Nam 5 tu·ªïi. H·ªèi nƒÉm nay ch·ªã Mai bao nhi√™u tu·ªïi?,2 tu·ªïi,12 tu·ªïi,13 tu·ªïi, ,B
Gi·∫£i b√†i to√°n v·ªÅ nhi·ªÅu h∆°n m·ªôt s·ªë ƒë∆°n v·ªã ta th·ª±c hi·ªán ph√©p t√≠nh g√¨?,Ph√©p tr·ª´,Ph√©p c·ªông, , ,B`, backgroundImage: backgrounds.default_space, audio: playSciFiMusic, evolution: ['üèóÔ∏è', 'üõ†Ô∏è', 'üöÄ', '‚ú®'], evolutionTriggers: [0, 1, 2, 3], badge: 'üèÖ' },
            science: { title: 'Ph√≤ng Th√≠ Nghi·ªám B√≠ ·∫®n', icon: 'ü™ê', intro: "Nh√† khoa h·ªçc t√†i ba ∆°i! C√°c th√≠ nghi·ªám ƒëang ch·ªù b·∫°n. M·ªói c√¢u tr·∫£ l·ªùi ƒë√∫ng s·∫Ω gi√∫p h√†nh tinh c·ªßa ch√∫ng ta th√™m xanh t∆∞∆°i ƒë√≥!", progressText: 'Th√≠ nghi·ªám', questions: `N∆∞·ªõc chi·∫øm bao nhi√™u ph·∫ßn trƒÉm b·ªÅ m·∫∑t Tr√°i ƒê·∫•t?,51%,61%,71%,81%,C\nCh·∫•t n√†o c·∫ßn thi·∫øt cho s·ª± quang h·ª£p c·ªßa c√¢y xanh?,Oxy,Carbon Dioxide,Nit∆°,Hydro,B\nH√†nh tinh n√†o ƒë∆∞·ª£c m·ªánh danh l√† "H√†nh tinh ƒê·ªè"?,Sao Kim,Sao H·ªèa,Sao M·ªôc,Sao Th·ªï,B\nƒê∆°n v·ªã c∆° b·∫£n c·ªßa s·ª± s·ªëng l√† g√¨?,Ph√¢n t·ª≠,T·∫ø b√†o,M√¥,C∆° quan,B\nLo√†i ƒë·ªông v·∫≠t c√≥ v√∫ n√†o bi·∫øt bay?,Chim c√°nh c·ª•t,D∆°i,ƒê√† ƒëi·ªÉu,C√° heo,B`, backgroundImage: `url('https://images.unsplash.com/photo-1446776811953-b23d579424c8?q=80&w=2070&auto=format&fit=crop')`, audio: playSciFiMusic, evolution: ['üåë', 'üíß', 'üå±', 'üå≥'], evolutionTriggers: [0, 2, 4, 6], badge: 'üî¨' },
            jungle: { title: 'Cu·ªôc ƒêua K·ª≥ Th√∫', icon: 'üå≥', intro: "Nh√† th√°m hi·ªÉm d≈©ng c·∫£m, khu r·ª´ng r·∫≠m r·∫°p ƒë·∫ßy th·ª≠ th√°ch ƒëang ch·ªù ƒë·ª£i. H√£y v∆∞·ª£t qua c√°c c√¢u h·ªèi ƒë·ªÉ xem c√°i c√¢y c·ªßa b·∫°n l·ªõn nhanh th·∫ø n√†o nh√©!", progressText: 'Th·ª≠ th√°ch', questions: `Lo√†i ƒë·ªông v·∫≠t n√†o ƒë∆∞·ª£c m·ªánh danh l√† "ch√∫a t·ªÉ s∆°n l√¢m"?,S∆∞ t·ª≠,H·ªï,B√°o,Voi,A\nC√¢y n√†o sau ƒë√¢y th∆∞·ªùng m·ªçc ·ªü sa m·∫°c?,C√¢y th√¥ng,C√¢y d∆∞∆°ng x·ªâ,C√¢y x∆∞∆°ng r·ªìng,C√¢y phong,C\nCon v·∫≠t n√†o c√≥ th·ªÉ thay ƒë·ªïi m√†u s·∫Øc ƒë·ªÉ ng·ª•y trang?,T·∫Øc k√® hoa,H√† m√£,G·∫•u tr√∫c,Kangaroo,A\n"Vua c·ªßa c√°c lo√†i tr√°i c√¢y" ·ªü v√πng nhi·ªát ƒë·ªõi l√† qu·∫£ g√¨?,Xo√†i,D·ª©a,S·∫ßu ri√™ng,M√≠t,C\nD√≤ng s√¥ng d√†i nh·∫•t th·∫ø gi·ªõi l√† s√¥ng n√†o?,S√¥ng Mekong,S√¥ng Nile,S√¥ng Amazon,S√¥ng Mississippi,C`, backgroundImage: backgrounds.default_jungle, audio: playJungleMusic, evolution: ['üå±', 'üåø', 'üå≥', 'üêí'], evolutionTriggers: [0, 2, 4, 6], badge: 'üå¥' },
            ocean: { title: 'SƒÉn T√¨m Kho B√°u', icon: 'üê†', intro: "N√†o ta c√πng dong bu·ªìm ra kh∆°i! Chi·∫øc r∆∞∆°ng kho b√°u b√≠ ·∫©n ƒëang b·ªã kh√≥a ch·∫∑t. Tr·∫£ l·ªùi ƒë√∫ng ƒë·ªÉ t√¨m ch√¨a kh√≥a v√† kh√°m ph√° b√≠ m·∫≠t b√™n trong!", progressText: 'C·ª≠a ·∫£i', questions: `Lo√†i c√° n√†o l·ªõn nh·∫•t th·∫ø gi·ªõi?,C√° m·∫≠p tr·∫Øng,C√° voi xanh,C√° nh√°m voi,C√° heo,C\nH·∫ßu h·∫øt san h√¥ ƒë∆∞·ª£c t√¨m th·∫•y ·ªü v√πng n∆∞·ªõc n√†o?,N∆∞·ªõc ·∫•m, n√¥ng,N∆∞·ªõc l·∫°nh, s√¢u,N∆∞·ªõc ng·ªçt,N∆∞·ªõc l·ª£,A\nƒê·∫°i d∆∞∆°ng n√†o l·ªõn nh·∫•t tr√™n Tr√°i ƒê·∫•t?,ƒê·∫°i T√¢y D∆∞∆°ng,·∫§n ƒê·ªô D∆∞∆°ng,Th√°i B√¨nh D∆∞∆°ng,B·∫Øc BƒÉng D∆∞∆°ng,C\nLo√†i v·∫≠t n√†o c√≥ 8 x√∫c tu?,S·ª©a,C√° heo,B·∫°ch tu·ªôc,Cua,C\nHi·ªán t∆∞·ª£ng n∆∞·ªõc bi·ªÉn d√¢ng l√™n v√† h·∫° xu·ªëng g·ªçi l√† g√¨?,S√≥ng th·∫ßn,Th·ªßy tri·ªÅu,B√£o,L·ªëc xo√°y,B`, backgroundImage: backgrounds.default_ocean, audio: playOceanMusic, evolution: ['üì¶', 'üóùÔ∏è', '‚ú®', 'üíé'], evolutionTriggers: [0, 2, 4, 6], badge: 'üê†' },
            fairytale: { title: 'L√¢u ƒê√†i Ph√©p Thu·∫≠t', icon: 'üè∞', intro: "Ho√†ng t·ª≠ v√† c√¥ng ch√∫a ∆°i! Th·∫ø gi·ªõi c·ªï t√≠ch di·ªáu k·ª≥ ƒëang m·ªü ra. H√£y d√πng tr√≠ th√¥ng minh ƒë·ªÉ x√¢y d·ª±ng n√™n t√≤a l√¢u ƒë√†i tr√°ng l·ªá c·ªßa ri√™ng m√¨nh nh√©!", progressText: 'Ch∆∞∆°ng', questions: `Trong truy·ªán T·∫•m C√°m, T·∫•m ƒë√£ bi·∫øn th√†nh con v·∫≠t n√†o ƒë·∫ßu ti√™n?,Con chim v√†ng anh,Con c√° b·ªëng,Con g√†,Con m√®o,A\nAi ƒë√£ gi√∫p L·ªç Lem ƒëi d·ª± v≈© h·ªôi?,B√† ti√™n,√îng b·ª•t,M·∫π k·∫ø,Ph√π th·ªßy,A\nN√†ng B·∫°ch Tuy·∫øt ƒë√£ ƒÉn ph·∫£i th·ª© g√¨ c·ªßa m·ª• ph√π th·ªßy?,Qu·∫£ t√°o ƒë·ªôc,Qu·∫£ l√™ ƒë·ªôc,Qu·∫£ cam ƒë·ªôc,Qu·∫£ nho ƒë·ªôc,A\nNh√¢n v·∫≠t n√†o c√≥ chi·∫øc m≈©i d√†i ra khi n√≥i d·ªëi?,C·∫≠u b√© Pinocchio,C·∫≠u b√© b√∫t ch√¨,C·∫≠u b√© ng∆∞·ªùi g·ªó,C·∫≠u b√© r∆°m,A\nTrong truy·ªán "S·ª± t√≠ch c√¢y v√∫ s·ªØa", c·∫≠u b√© ƒë√£ l√†m g√¨ khi·∫øn m·∫π bu·ªìn?,Ham ch∆°i kh√¥ng v·ªÅ,N√≥i d·ªëi m·∫π,Kh√¥ng nghe l·ªùi m·∫π,T·∫•t c·∫£ c√°c ƒë√°p √°n tr√™n,D`, backgroundImage: backgrounds.default_fairytale, audio: playFairyTaleMusic, evolution: ['üéÉ', '‚ú®', 'üëë', 'üè∞'], evolutionTriggers: [0, 2, 4, 6], badge: 'üëë' },
            vietnam: { title: 'Kh√°m Ph√° Vi·ªát Nam Di·ªáu K·ª≥', icon: 'üáªüá≥', intro: "B·∫°n ƒë√£ s·∫µn s√†ng cho chuy·∫øn du l·ªãch v√≤ng quanh Vi·ªát Nam ch∆∞a? M·ªói c√¢u tr·∫£ l·ªùi ƒë√∫ng s·∫Ω ƒë∆∞a ch√∫ng ta ƒë·∫øn m·ªôt ƒë·ªãa danh m·ªõi tr√™n b·∫£n ƒë·ªì h√¨nh ch·ªØ S!", progressText: 'Tr·∫°m', questions: `V·ªãnh n√†o c·ªßa Vi·ªát Nam ƒë∆∞·ª£c UNESCO c√¥ng nh·∫≠n l√† Di s·∫£n Thi√™n nhi√™n Th·∫ø gi·ªõi?,V·ªãnh Cam Ranh,V·ªãnh LƒÉng C√¥,V·ªãnh H·∫° Long,V·ªãnh Vƒ©nh Hy,C\nPh·ªü l√† m√≥n ƒÉn ƒë·∫∑c tr∆∞ng c·ªßa mi·ªÅn n√†o?,Mi·ªÅn Nam,Mi·ªÅn Trung,Mi·ªÅn B·∫Øc,Mi·ªÅn T√¢y,C\nTh√†nh ph·ªë n√†o ƒë∆∞·ª£c m·ªánh danh l√† "Th√†nh ph·ªë ng√†n hoa"?,ƒê√† L·∫°t,Nha Trang,H·ªôi An,Sa Pa,A\nQu·∫ßn ƒë·∫£o n√†o c·ªßa Vi·ªát Nam n·∫±m ·ªü ph√≠a T√¢y Nam c·ªßa T·ªï qu·ªëc?,Qu·∫ßn ƒë·∫£o Ho√†ng Sa,Qu·∫ßn ƒë·∫£o Tr∆∞·ªùng Sa,Qu·∫ßn ƒë·∫£o Th·ªï Chu,Qu·∫ßn ƒë·∫£o C√¥n S∆°n,C\nL·ªÖ h·ªôi n√†o sau ƒë√¢y l√† m·ªôt l·ªÖ h·ªôi l·ªõn ·ªü ƒê·ªìng b·∫±ng S√¥ng C·ª≠u Long?,L·ªÖ h·ªôi Ch√πa H∆∞∆°ng,L·ªÖ h·ªôi ƒê·ªÅn H√πng,L·ªÖ h·ªôi Ok Om Bok,L·ªÖ h·ªôi G·∫ßu T√†o,C`, backgroundImage: backgrounds.default_vietnam, audio: playVietnamMusic, evolution: ['üó∫Ô∏è', 'üìç', '‚≠ê', 'üáªüá≥'], evolutionTriggers: [0, 2, 4, 6], badge: '‚≠ê' }
        };
        const correctFeedbackTexts = [ "Tuy·ªát v·ªùi!", "Ch√≠nh x√°c!", "L√†m t·ªët l·∫Øm!", "B·∫°n gi·ªèi qu√°!", "Xu·∫•t s·∫Øc!" ];
        const wrongFeedbackTexts = [ "C·ªë l√™n n√†o!", "Sai m·ªôt ch√∫t th√¥i!", "Th·ª≠ l·∫°i c√¢u sau nh√©!", "ƒê·ª´ng n·∫£n l√≤ng!", "Ti·∫øp t·ª•c c·ªë g·∫Øng!" ];

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const setupTitle = document.getElementById('setup-title');
        const questionsInput = document.getElementById('questions-input');
        const startGameBtn = document.getElementById('start-from-intro-btn');
        const setupError = document.getElementById('setup-error');
        const progressIndicator = document.getElementById('progress-indicator');
        const timerDisplay = document.getElementById('timer');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const helpBtn = document.getElementById('help-btn');
        const resultTitle = document.getElementById('result-title');
        const resultIcon = document.getElementById('result-icon');
        const resultMessage = document.getElementById('result-message');
        const volumeControl = document.getElementById('volume-control');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const backgroundOptionsContainer = document.getElementById('background-options');
        const resetBgBtn = document.getElementById('reset-bg-btn');
        const mascot = document.getElementById('mascot');
        const confettiContainer = document.getElementById('confetti-container');
        const evolutionDisplay = document.getElementById('evolution-display');
        const pauseBtn = document.getElementById('pause-btn');
        const pauseModal = document.getElementById('pause-modal');
        const resumeBtn = document.getElementById('resume-btn');
        const scoreDisplay = document.getElementById('score-display');
        const badgeCollectionContainer = document.getElementById('badge-collection');
        const finalScoreDisplay = document.getElementById('final-score-display');
        const timeSettingInput = document.getElementById('time-setting-input');
        const quitGameBtn = document.getElementById('quit-game-btn');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const missionIntroText = document.getElementById('intro-text');
        const missionSelectForEdit = document.getElementById('mission-select-for-edit');
        const fullscreenControl = document.getElementById('fullscreen-control');
        const introModal = document.getElementById('intro-modal');
        const introIcon = document.getElementById('intro-icon');
        const introTitle = document.getElementById('intro-title');
        const backFromIntroBtn = document.getElementById('back-from-intro-btn');
        const continueToThanksBtn = document.getElementById('continue-to-thanks-btn');
        const homeBtn = document.getElementById('home-btn');
        const fireworksCanvas = document.getElementById('fireworks-canvas');

        // --- Game State ---
        let questions = []; let currentQuestionIndex = 0; let timeLeft = 20; let timerInterval; let isHelpUsed = false; let isMuted = false; let currentMission; let score = 0; let currentMissionId;
        
        // --- Audio Engine ---
        let audioCtx; let activeAudioNodes = [];
        function initAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } }
        function stopBackgroundMusic() { activeAudioNodes.forEach(node => { if (typeof node.stop === 'function') { node.stop(); } if (typeof node.disconnect === 'function') { node.disconnect(); } }); activeAudioNodes = []; }
        
        function playSciFiMusic() { if (!audioCtx || isMuted) return; stopBackgroundMusic(); const melody = [ 261, 261, 392, 392, 440, 440, 392, 349, 349, 329, 329, 293, 293, 261 ]; const noteDuration = 0.3; const intervalTime = 400; let currentNote = 0; const melodyInterval = setInterval(() => { if (isMuted) return; const freq = melody[currentNote]; if (freq) { const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); oscillator.type = 'triangle'; oscillator.frequency.value = freq; gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + noteDuration); oscillator.start(audioCtx.currentTime); oscillator.stop(audioCtx.currentTime + noteDuration); } currentNote = (currentNote + 1) % melody.length; }, intervalTime); activeAudioNodes.push({ stop: () => clearInterval(melodyInterval) }); }
        function playJungleMusic() { if (!audioCtx || isMuted) return; stopBackgroundMusic(); const tomGain = audioCtx.createGain(); tomGain.gain.value = 0.3; tomGain.connect(audioCtx.destination); const tomInterval = setInterval(() => { if(isMuted) return; const tom = audioCtx.createOscillator(); tom.type = 'sine'; tom.frequency.setValueAtTime(150, audioCtx.currentTime); tomGain.gain.setValueAtTime(0.3, audioCtx.currentTime); tomGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5); tom.connect(tomGain); tom.start(); tom.stop(audioCtx.currentTime + 0.5); }, 1500); const cricketGain = audioCtx.createGain(); cricketGain.gain.value = 0.03; const cricket = audioCtx.createOscillator(); cricket.type = 'triangle'; cricket.frequency.value = 4000; const cricketLFO = audioCtx.createOscillator(); cricketLFO.type = 'square'; cricketLFO.frequency.value = 5; cricketLFO.connect(cricketGain.gain); cricket.connect(cricketGain).connect(audioCtx.destination); cricket.start(); cricketLFO.start(); activeAudioNodes.push({ stop: () => clearInterval(tomInterval) }, cricket, cricketLFO); }
        function playOceanMusic() { if (!audioCtx || isMuted) return; stopBackgroundMusic(); const bufferSize = 4096; let lastOut = 0.0; const node = audioCtx.createScriptProcessor(bufferSize, 1, 1); node.onaudioprocess = function(e) { const output = e.outputBuffer.getChannelData(0); for (let i = 0; i < bufferSize; i++) { const white = Math.random() * 2 - 1; output[i] = (lastOut + (0.02 * white)) / 1.02; lastOut = output[i]; output[i] *= 3.5; } }; const gainNode = audioCtx.createGain(); gainNode.gain.value = 0.1; node.connect(gainNode).connect(audioCtx.destination); const bubbleInterval = setInterval(() => { if (isMuted) return; const bubble = audioCtx.createOscillator(); const bubbleGain = audioCtx.createGain(); bubble.connect(bubbleGain).connect(audioCtx.destination); const now = audioCtx.currentTime; bubble.frequency.setValueAtTime(500 + Math.random() * 500, now); bubble.frequency.exponentialRampToValueAtTime(1500 + Math.random() * 500, now + 0.2); bubbleGain.gain.setValueAtTime(0.1, now); bubbleGain.gain.exponentialRampToValueAtTime(0.001, now + 0.2); bubble.start(now); bubble.stop(now + 0.2); }, 2000 + Math.random() * 2000); activeAudioNodes.push(node, { stop: () => clearInterval(bubbleInterval) }); }
        function playFairyTaleMusic() { if (!audioCtx || isMuted) return; stopBackgroundMusic(); const melody = [523, 587, 659, 698, 783, 880, 783, 698]; const noteDuration = 0.35; let currentNote = 0; const melodyInterval = setInterval(() => { if (isMuted) return; const freq = melody[currentNote]; if (freq) { const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode).connect(audioCtx.destination); oscillator.type = 'sine'; oscillator.frequency.value = freq; gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + noteDuration); oscillator.start(audioCtx.currentTime); oscillator.stop(audioCtx.currentTime + noteDuration); } currentNote = (currentNote + 1) % melody.length; }, 450); activeAudioNodes.push({ stop: () => clearInterval(melodyInterval) }); }
        function playVietnamMusic() { if (!audioCtx || isMuted) return; stopBackgroundMusic(); const melody = [261, 293, 329, 392, 440, 392, 329, 293]; const noteDuration = 0.4; let currentNote = 0; const melodyInterval = setInterval(() => { if (isMuted) return; const freq = melody[currentNote]; if (freq) { const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode).connect(audioCtx.destination); oscillator.type = 'triangle'; oscillator.frequency.value = freq; gainNode.gain.setValueAtTime(0.12, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + noteDuration); oscillator.start(audioCtx.currentTime); oscillator.stop(audioCtx.currentTime + noteDuration); } currentNote = (currentNote + 1) % melody.length; }, 500); activeAudioNodes.push({ stop: () => clearInterval(melodyInterval) }); }
        
        function playSound(type) {
            if (!audioCtx || isMuted) return;
            switch (type) {
                case 'correct': {
                    // This creates a sound resembling a short burst of applause
                    for (let i = 0; i < 25; i++) {
                        const noiseSource = audioCtx.createBufferSource();
                        const bufferSize = audioCtx.sampleRate * 0.5; // Longer clap sound
                        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let j = 0; j < bufferSize; j++) {
                            data[j] = Math.random() * 2 - 1;
                        }
                        noiseSource.buffer = buffer;

                        const bandpass = audioCtx.createBiquadFilter();
                        bandpass.type = 'bandpass';
                        bandpass.frequency.value = 1200 + Math.random() * 1500;

                        const gainNode = audioCtx.createGain();
                        const delay = Math.random() * 0.8; // Spread out claps over 0.8s

                        gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime + delay);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + 0.3);
                        
                        noiseSource.connect(bandpass).connect(gainNode).connect(audioCtx.destination);
                        noiseSource.start(audioCtx.currentTime + delay);
                    }

                    // Cheering part
                    for (let i = 0; i < 8; i++) { // 8 "voices"
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();

                        // Vibrato
                        const lfo = audioCtx.createOscillator();
                        lfo.frequency.value = Math.random() * 5 + 4; // Vibrato speed
                        const lfoGain = audioCtx.createGain();
                        lfoGain.gain.value = 10 + Math.random() * 10; // Vibrato depth

                        lfo.connect(lfoGain).connect(oscillator.frequency);

                        oscillator.type = 'sawtooth';
                        oscillator.frequency.value = 300 + Math.random() * 300; // Voice pitch
                        
                        const delay = Math.random() * 0.3;
                        gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + delay + 0.1); // Fade in
                        gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + delay + 1.0); // Fade out over 1s

                        oscillator.connect(gainNode).connect(audioCtx.destination);
                        
                        oscillator.start(audioCtx.currentTime + delay);
                        lfo.start(audioCtx.currentTime + delay);
                        oscillator.stop(audioCtx.currentTime + delay + 1.2);
                        lfo.stop(audioCtx.currentTime + delay + 1.2);
                    }

                    return;
                }
                case 'wrong': {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3 note
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.7);
                    oscillator.connect(gainNode).connect(audioCtx.destination);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 1);
                    return;
                }
                case 'tick': {
                    const oscillator = audioCtx.createOscillator();
                    const tickGain = audioCtx.createGain();
                    tickGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                    tickGain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
                    oscillator.connect(tickGain).connect(audioCtx.destination);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    return;
                }
                case 'click': {
                     const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4 note
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
                    oscillator.connect(gainNode).connect(audioCtx.destination);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 1);
                    return;
                }
                case 'win': {
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    [659, 783, 1046].forEach((freq, i) => { // E5, G5, C6
                        const osc = audioCtx.createOscillator();
                        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.2);
                        osc.connect(gainNode).connect(audioCtx.destination);
                        osc.start(audioCtx.currentTime + i * 0.2);
                        osc.stop(audioCtx.currentTime + i * 0.2 + 0.2);
                    });
                    return;
                }
                case 'lose': {
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    [349, 261, 174].forEach((freq, i) => { // F4, C4, F3
                        const osc = audioCtx.createOscillator();
                        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.25);
                        osc.connect(gainNode).connect(audioCtx.destination);
                        osc.start(audioCtx.currentTime + i * 0.25);
                        osc.stop(audioCtx.currentTime + i * 0.25 + 0.2);
                    });
                    return;
                }
                 case 'firework': {
                    // Whistle sound
                    const whistle = audioCtx.createOscillator();
                    const whistleGain = audioCtx.createGain();
                    whistle.type = 'sine';
                    whistle.frequency.setValueAtTime(200, audioCtx.currentTime);
                    whistle.frequency.linearRampToValueAtTime(1500, audioCtx.currentTime + 0.5);
                    whistleGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    whistleGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                    whistle.connect(whistleGain).connect(audioCtx.destination);
                    whistle.start();
                    whistle.stop(audioCtx.currentTime + 0.5);

                    // Explosion sound
                    const noiseSource = audioCtx.createBufferSource();
                    const bufferSize = audioCtx.sampleRate * 1;
                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }
                    noiseSource.buffer = buffer;
                    const noiseGain = audioCtx.createGain();
                    noiseGain.gain.setValueAtTime(0.5, audioCtx.currentTime + 0.5);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);
                    noiseSource.connect(noiseGain).connect(audioCtx.destination);
                    noiseSource.start(audioCtx.currentTime + 0.5);
                    noiseSource.stop(audioCtx.currentTime + 1.2);
                    return;
                }
            }
        }

        // --- Effects & Badge Functions ---
        function updateMascot(state) { mascot.classList.remove('mascot-bounce'); void mascot.offsetWidth; switch (state) { case 'happy': mascot.textContent = 'ü•≥'; mascot.classList.add('mascot-bounce'); break; case 'sad': mascot.textContent = 'üòü'; break; case 'worried': mascot.textContent = 'üò®'; break; case 'neutral': default: mascot.textContent = 'üöÄ'; break; } }
        function createSparkles(element) { const rect = element.getBoundingClientRect(); for (let i = 0; i < 15; i++) { const sparkle = document.createElement('div'); sparkle.className = 'sparkle'; document.body.appendChild(sparkle); const angle = Math.random() * 360; const distance = Math.random() * 50 + 50; sparkle.style.top = `${rect.top + rect.height / 2}px`; sparkle.style.left = `${rect.left + rect.width / 2}px`; sparkle.style.setProperty('--tx', `${Math.cos(angle * Math.PI / 180) * distance}px`); sparkle.style.setProperty('--ty', `${Math.sin(angle * Math.PI / 180) * distance}px`); setTimeout(() => sparkle.remove(), 600); } }
        function triggerConfetti() { const colors = ['#0ea5e9', '#6366f1', '#10b981', '#facc15', '#ec4899']; for (let i = 0; i < 150; i++) { const piece = document.createElement('div'); piece.className = 'confetti-piece'; piece.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]); piece.style.left = `${Math.random() * 100}vw`; piece.style.animationDelay = `${Math.random() * 2}s`; piece.style.transform = `scale(${Math.random() * 0.5 + 0.5})`; confettiContainer.appendChild(piece); } setTimeout(() => confettiContainer.innerHTML = '', 5000); }
        function updateEvolutionDisplay() { const { evolution, evolutionTriggers } = currentMission; let currentStageIndex = 0; for (let i = 0; i < evolutionTriggers.length; i++) { if (currentQuestionIndex >= evolutionTriggers[i]) { currentStageIndex = i; } } const newIcon = evolution[currentStageIndex]; if (evolutionDisplay.textContent !== newIcon) { evolutionDisplay.textContent = newIcon; evolutionDisplay.classList.add('evolved'); setTimeout(() => evolutionDisplay.classList.remove('evolved'), 500); } }
        function getBadges() { const badges = localStorage.getItem('rungChuongVangBadges'); return badges ? JSON.parse(badges) : []; }
        function saveBadge(missionId) { const badges = getBadges(); if (!badges.includes(missionId)) { badges.push(missionId); localStorage.setItem('rungChuongVangBadges', JSON.stringify(badges)); } }
        function displayBadges() { const collectedBadges = getBadges(); badgeCollectionContainer.innerHTML = ''; Object.keys(missions).forEach(missionId => { const mission = missions[missionId]; const badgeEl = document.createElement('div'); badgeEl.title = mission.title; if (collectedBadges.includes(missionId)) { badgeEl.textContent = mission.badge; badgeEl.classList.add('opacity-100', 'cursor-pointer'); } else { badgeEl.textContent = '‚ùì'; badgeEl.classList.add('opacity-30'); } badgeCollectionContainer.appendChild(badgeEl); }); }
        
        // --- Background & Time Functions ---
        function getGameTime() { const savedTime = localStorage.getItem('rungChuongVangTime'); return savedTime ? parseInt(savedTime) : 180; }
        function applyBackground(bgUrl) { document.body.style.backgroundImage = bgUrl; }
        function updateSelectedBgVisual() { const selectedBg = localStorage.getItem('userBackground'); document.querySelectorAll('.bg-option').forEach(option => { option.classList.toggle('selected', option.dataset.bgUrl === selectedBg); }); }
        function selectBackground(bgUrl) { playSound('click'); applyBackground(bgUrl); localStorage.setItem('userBackground', bgUrl); updateSelectedBgVisual(); }
        function resetBackground() { localStorage.removeItem('userBackground'); const targetBg = (currentMission && !document.getElementById('main-menu-screen').classList.contains('active')) ? currentMission.backgroundImage : missions.space.backgroundImage; applyBackground(targetBg); updateSelectedBgVisual(); }
        function populateBackgroundOptions() { backgroundOptionsContainer.innerHTML = ''; Object.entries(backgrounds).forEach(([key, url]) => { const option = document.createElement('div'); option.className = 'bg-option h-24 md:h-32 rounded-lg cursor-pointer bg-cover bg-center transition-all duration-200 hover:scale-105'; option.style.backgroundImage = url; option.dataset.bgUrl = url; option.addEventListener('click', () => selectBackground(url)); backgroundOptionsContainer.appendChild(option); }); }

        // --- Navigation & Pause ---
        function switchScreen(screenId) { screens.forEach(screen => { screen.classList.toggle('active', screen.id === screenId); }); }
        function goToMenu() { stopBackgroundMusic(); stopFireworks(); fireworksCanvas.style.display = 'none'; const userBg = localStorage.getItem('userBackground'); if (!userBg) { applyBackground(missions.space.backgroundImage); } updateMascot('neutral'); evolutionDisplay.textContent = ''; currentMission = null; displayBadges(); switchScreen('main-menu-screen'); }
        function prepareGame(missionId) { playSound('click'); currentMissionId = missionId; currentMission = missions[missionId]; const userBg = localStorage.getItem('userBackground'); if (!userBg) { applyBackground(currentMission.backgroundImage); } introIcon.textContent = currentMission.icon; introTitle.textContent = currentMission.title; missionIntroText.textContent = currentMission.intro; introModal.classList.remove('hidden'); introModal.classList.add('flex'); }
        function pauseGame() { playSound('click'); clearInterval(timerInterval); stopBackgroundMusic(); pauseModal.classList.remove('hidden'); pauseModal.classList.add('flex'); }
        function resumeGame() { playSound('click'); pauseModal.classList.add('hidden'); pauseModal.classList.remove('flex'); if (!isMuted) { currentMission.audio(); } startTimer(true); } // Pass true to indicate resume
        function toggleFullScreen() {
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) { // Firefox
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        }
        
        // --- Event Listeners ---
        document.querySelectorAll('.mission-btn').forEach(btn => { btn.addEventListener('click', (e) => prepareGame(e.target.dataset.missionId)); });
        
        backFromIntroBtn.addEventListener('click', () => { playSound('click'); introModal.classList.add('hidden'); introModal.classList.remove('flex'); });
        homeBtn.addEventListener('click', () => { playSound('click'); goToMenu(); });
        
        continueToThanksBtn.addEventListener('click', () => {
            playSound('click');
            switchScreen('thank-you-screen');
            fireworksCanvas.style.display = 'block';
            startFireworks();
        });
        settingsBtn.addEventListener('click', () => { playSound('click'); settingsModal.classList.remove('hidden'); settingsModal.classList.add('flex'); timeSettingInput.value = getGameTime(); missionSelectForEdit.innerHTML = ''; Object.keys(missions).forEach(missionId => { const option = document.createElement('option'); option.value = missionId; option.textContent = missions[missionId].title; missionSelectForEdit.appendChild(option); }); const firstMissionId = Object.keys(missions)[0]; missionSelectForEdit.value = firstMissionId; questionsInput.value = missions[firstMissionId].questions; updateSelectedBgVisual(); });
        closeSettingsBtn.addEventListener('click', () => { playSound('click'); const newTime = parseInt(timeSettingInput.value); if (newTime && newTime >= 5 && newTime <= 180) { localStorage.setItem('rungChuongVangTime', newTime); } else { timeSettingInput.value = getGameTime(); } const missionIdToSave = missionSelectForEdit.value; const newQuestionsText = questionsInput.value.trim(); const questionLines = newQuestionsText.split("\n").filter(line => line.trim() !== ''); const areQuestionsValid = questionLines.every(line => line.split(',').length === 6); if (newQuestionsText === '' || !areQuestionsValid) { setupError.textContent = "L·ªói ƒë·ªãnh d·∫°ng c√¢u h·ªèi, kh√¥ng th·ªÉ l∆∞u!"; setupError.classList.remove('hidden'); return; } else { setupError.classList.add('hidden'); missions[missionIdToSave].questions = newQuestionsText; } settingsModal.classList.add('hidden'); settingsModal.classList.remove('flex'); });
        resetBgBtn.addEventListener('click', () => { playSound('click'); resetBackground(); });
        missionSelectForEdit.addEventListener('change', () => { const selectedMissionId = missionSelectForEdit.value; questionsInput.value = missions[selectedMissionId].questions; });
        volumeControl.addEventListener('click', () => { isMuted = !isMuted; volumeControl.textContent = isMuted ? 'üîá' : 'üîä'; if (isMuted) { stopBackgroundMusic(); } else { initAudio(); if (currentMission && document.getElementById('game-screen').classList.contains('active')) { currentMission.audio(); } } });
        startGameBtn.addEventListener('click', () => { initAudio(); playSound('click'); introModal.classList.add('hidden'); introModal.classList.remove('flex'); const rawQuestions = currentMission.questions.trim(); parseQuestions(rawQuestions); if (questions.length === 0) { alert("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i trong ph·∫ßn C√†i ƒê·∫∑t."); return; } currentQuestionIndex = 0; isHelpUsed = false; score = 0; scoreDisplay.textContent = 'ƒêi·ªÉm: 0'; switchScreen('game-screen'); currentMission.audio(); showQuestion(); });
        helpBtn.addEventListener('click', useHelp);
        pauseBtn.addEventListener('click', pauseGame);
        resumeBtn.addEventListener('click', resumeGame);
        quitGameBtn.addEventListener('click', () => { playSound('click'); goToMenu(); });
        fullscreenControl.addEventListener('click', () => { playSound('click'); toggleFullScreen(); });


        // --- Game Flow ---
        function parseQuestions(rawText) { questions=rawText.split("\n").map(e=>e.trim()).filter(e=>e.length>0).map(e=>{let parts=e.split(",");while(parts.length<6)parts.push("");return{question:parts[0].trim(),answers:[{text:parts[1].trim(),id:"A"},{text:parts[2].trim(),id:"B"},{text:parts[3].trim(),id:"C"},{text:parts[4].trim(),id:"D"}],correctAnswer:parts[5].trim().toUpperCase()}})}
        
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) { winGame(); return; }
            updateMascot('neutral');
            resetState();
            updateEvolutionDisplay();
            const q = questions[currentQuestionIndex];
            const questionContainer = document.getElementById('question-container');

            questionText.textContent = q.question;
            progressIndicator.textContent = `${currentMission.progressText} ${currentQuestionIndex + 1}/${questions.length}`;
            answersContainer.innerHTML = '';
            q.answers.forEach(a => {
                if (a.text.trim() === '') return;
                const b = document.createElement('button');
                b.className = 'btn-glow w-full text-3xl p-4 text-left';
                b.dataset.answerId = a.id;
                b.innerHTML = `<span class="bg-slate-700 text-cyan-300 rounded-full px-3 py-1 mr-4 font-bold">${a.id}</span> ${a.text}`;
                b.onclick = () => selectAnswer(a.id, b);
                answersContainer.appendChild(b);
            });
            startTimer();

            questionContainer.classList.remove('pop-in');
            void questionContainer.offsetWidth; // Force reflow
            questionContainer.classList.add('pop-in');
        }

        function selectAnswer(selectedId, button) {
            clearInterval(timerInterval);
            disableAnswerButtons();
            const isCorrect = selectedId === questions[currentQuestionIndex].correctAnswer;
            if (isCorrect) {
                playSound('correct');
                const points = 100 + (timeLeft * 5);
                score += points;
                scoreDisplay.textContent = `ƒêi·ªÉm: ${score}`;
                createSparkles(button);
                updateMascot('happy');
                button.classList.add('correct-answer-glow');
                button.style.background = "linear-gradient(45deg, #22c55e, #10b981)";
                button.style.boxShadow = "0 0 20px rgba(34, 197, 94, 0.7)";
                
                const randomCorrectText = correctFeedbackTexts[Math.floor(Math.random() * correctFeedbackTexts.length)];
                feedbackOverlay.textContent = randomCorrectText;
                feedbackOverlay.style.backgroundColor = 'rgba(34, 197, 94, 0.8)';
                feedbackOverlay.style.opacity = "1";

                setTimeout(() => {
                    feedbackOverlay.style.opacity = "0";
                    setTimeout(() => {
                        button.classList.remove('correct-answer-glow');
                    }, 500);
                    currentQuestionIndex++;
                    showQuestion();
                }, 1500);
            } else {
                playSound('wrong');
                score = Math.max(0, score - 50);
                scoreDisplay.textContent = `ƒêi·ªÉm: ${score}`;
                updateMascot('sad');
                button.classList.add('shake-it');
                button.style.background = "linear-gradient(45deg, #ef4444, #e11d48)";
                button.style.boxShadow = "0 0 20px rgba(239, 68, 68, 0.7)";
                
                const randomWrongText = wrongFeedbackTexts[Math.floor(Math.random() * wrongFeedbackTexts.length)];
                feedbackOverlay.textContent = randomWrongText;
                feedbackOverlay.style.backgroundColor = 'rgba(239, 68, 68, 0.8)';
                feedbackOverlay.style.opacity = "1";

                const correctButton = Array.from(answersContainer.children).find(btn => btn.dataset.answerId === questions[currentQuestionIndex].correctAnswer);
                if (correctButton) {
                    correctButton.style.background = 'linear-gradient(45deg, #22c55e, #10b981)';
                    correctButton.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.7)';
                }
                setTimeout(() => {
                    feedbackOverlay.style.opacity = "0";
                    button.classList.remove('shake-it');
                    currentQuestionIndex++;
                    showQuestion();
                }, 2000);
            }
        }
        function useHelp() { if(isHelpUsed)return; playSound("click"); isHelpUsed=!0; helpBtn.disabled=!0; helpBtn.classList.remove("pulsate"); const q=questions[currentQuestionIndex]; const incorrect = q.answers.filter(a => a.id !== q.correctAnswer).sort(()=>.5-Math.random()).slice(0,2); incorrect.forEach(a => { const btn = Array.from(answersContainer.children).find(b => b.dataset.answerId === a.id); if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; } }); }
        
        function startTimer(isResuming = false) {
            if (!isResuming) {
                timeLeft = getGameTime();
            }
            timerDisplay.textContent = timeLeft;
            timerInterval=setInterval(()=>{ 
                timeLeft--; 
                timerDisplay.textContent = timeLeft; 
                if (timeLeft <= 5) { 
                    timerDisplay.classList.add("timer-warning"); 
                    updateMascot('worried'); 
                    if(timeLeft > 0) playSound('tick'); 
                } else { 
                    timerDisplay.classList.remove("timer-warning"); 
                } 
                if (timeLeft <= 0) { 
                    clearInterval(timerInterval); 
                    playSound('wrong'); 
                    gameOver("H·∫øt th·ªùi gian!"); 
                } 
            }, 1000); 
        }

        function gameOver(message = "Nhi·ªám v·ª• th·∫•t b·∫°i!") { stopBackgroundMusic(); playSound('lose'); updateMascot('sad'); switchScreen('result-screen'); resultTitle.textContent = "TH·∫§T B·∫†I!"; resultIcon.innerHTML = 'üí•'; finalScoreDisplay.textContent = `ƒêi·ªÉm cu·ªëi: ${score}`; resultMessage.textContent = message; }
        function winGame() { stopBackgroundMusic(); playSound('win'); updateMascot('happy'); triggerConfetti(); saveBadge(currentMissionId); switchScreen('result-screen'); resultTitle.textContent = "HO√ÄN TH√ÄNH XU·∫§T S·∫ÆC!"; resultIcon.innerHTML = '<span class="winner-trophy">üèÜ</span>'; finalScoreDisplay.textContent = `ƒêi·ªÉm cu·ªëi: ${score}`; resultMessage.textContent = `Ch√∫c m·ª´ng! B·∫°n ƒë√£ v∆∞·ª£t qua t·∫•t c·∫£ th·ª≠ th√°ch c·ªßa ${currentMission.title}!`; }
        
        function resetState() { 
            clearInterval(timerInterval); 
            timeLeft = getGameTime();
            timerDisplay.classList.remove("timer-warning"); 
            helpBtn.disabled=isHelpUsed; 
            helpBtn.classList.toggle("pulsate", !isHelpUsed); 
        }

        function disableAnswerButtons() { Array.from(answersContainer.children).forEach(btn => { btn.disabled = true; btn.style.transform = 'none'; }); }

        // --- Fireworks Logic ---
        const fireworksCtx = fireworksCanvas.getContext('2d');
        let fireworks = [], particles = [], animationFrameId, launchIntervalId;
        const initFireworks = () => {
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
        };
        const startFireworks = () => {
            initFireworks();
            const loop = () => {
                fireworksCtx.fillStyle = 'rgba(15, 23, 42, 0.15)';
                fireworksCtx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
                
                fireworks.forEach((f, i) => { f.update(); f.draw(); if (f.done) fireworks.splice(i, 1); });
                particles.forEach((p, i) => { p.update(); p.draw(); if (p.done) particles.splice(i, 1); });
                
                animationFrameId = requestAnimationFrame(loop);
            };
            loop();
            launchIntervalId = setInterval(() => launchFirework(), 800);
        };
        const stopFireworks = () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (launchIntervalId) clearInterval(launchIntervalId);
            fireworks = []; particles = [];
            fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
        };
        const launchFirework = () => { 
            playSound('firework');
            fireworks.push(new Firework()); 
        };
        
        class Particle {
            constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.size = Math.random() * 2 + 1; this.alpha = 1; this.friction = 0.98; this.gravity = 0.1; const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 8 + 1; this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed; this.done = false; }
            update() { this.vy += this.gravity; this.vx *= this.friction; this.vy *= this.friction; this.x += this.vx; this.y += this.vy; this.alpha -= 0.02; if (this.alpha <= 0) this.done = true; }
            draw() { fireworksCtx.save(); fireworksCtx.globalAlpha = this.alpha; fireworksCtx.beginPath(); fireworksCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); fireworksCtx.fillStyle = this.color; fireworksCtx.fill(); fireworksCtx.restore(); }
        }

        class Firework {
            constructor() { this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; this.x = Math.random() * fireworksCanvas.width; this.y = fireworksCanvas.height; this.targetY = Math.random() * (fireworksCanvas.height / 2); this.vy = -6; this.done = false; }
            update() { this.y += this.vy; if (this.y < this.targetY) { this.explode(); this.done = true; } }
            draw() { fireworksCtx.beginPath(); fireworksCtx.arc(this.x, this.y, 3, 0, Math.PI * 2, false); fireworksCtx.fillStyle = this.color; fireworksCtx.fill(); }
            explode() { for (let i = 0; i < 50; i++) particles.push(new Particle(this.x, this.y, this.color)); }
        }

        // Initial load
        window.onload = () => {
             const userBg = localStorage.getItem('userBackground');
             if (userBg) { applyBackground(userBg); }
             populateBackgroundOptions();
             goToMenu();
             window.addEventListener('resize', initFireworks);
        };
    </script>
</body>
</html>

